<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IPTV Player ‚Äì M3U/M3U8</title>
  <!--
    IPTV Player ‚Äì single-file HTML
    Features:
    - Enter a .m3u8 or .m3u URL to play or browse items inside
    - Upload a local .m3u8/.m3u file
    - Parses M3U (#EXTINF) and HLS master playlists (#EXT-X-STREAM-INF)
    - Lists items for selection if a playlist is detected
    - Uses hls.js for HLS playback on browsers that lack native HLS
    - Remembers recent URLs in LocalStorage

    Notes about CORS:
    Many IPTV/HLS servers block cross-origin requests. If you see CORS errors,
    you must host this page on the same domain as the playlist or use your own
    proxy. Look for the CORS helper section in the code to enable a prefix.
  -->
  <style>
    :root{
      --bg:#0b0c0f; --panel:#13151a; --panel-2:#0f1116; --text:#eef2f6; --muted:#98a2b3;
      --accent:#2ea26a; --accent-2:#3b82f6; --card:#1a1f2b; --border:#263043; --danger:#ef4444;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial,sans-serif}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .grid{display:grid;grid-template-columns: 1.1fr .9fr;gap:18px}
    @media (max-width: 980px){.grid{grid-template-columns:1fr;}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .card-h{display:flex;align-items:center;gap:12px;padding:12px 14px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent)}
    .card-b{padding:14px}
    input[type="text"]{width:100%;box-sizing:border-box;background:#0f1420;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:10px 12px}
    button{cursor:pointer;border:1px solid var(--border);background:var(--panel);color:var(--text);border-radius:10px;padding:10px 12px}
    button.primary{background:var(--accent);border-color:transparent;color:white}
    button.ghost{background:transparent}
    button:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .stack{display:flex;flex-direction:column;gap:10px}
    .hint{color:var(--muted);font-size:12px}
    .pill{display:inline-flex;align-items:center;padding:3px 8px;border-radius:999px;border:1px solid var(--border);gap:6px}
    .list{max-height:420px;overflow:auto}
    .item{display:flex;align-items:center;gap:12px;padding:10px 12px;border-bottom:1px dashed var(--border);cursor:pointer}
    .item:hover{background:rgba(255,255,255,.04)}
    .title{font-weight:600}
    .meta{color:var(--muted);font-size:12px}
    .empty{color:var(--muted);padding:14px}
    .badge{font-size:11px;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    .danger{color:var(--danger)}
    .right{margin-left:auto}
    .recent{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .recent button{font-size:12px;padding:6px 8px}
    .logo{width:28px;height:28px;border-radius:6px;object-fit:cover;background:#0f1420;border:1px solid var(--border)}
    video{width:100%;height:auto;background:black;display:block}
    .nowplaying{display:flex;align-items:center;gap:10px}
    .spinner{width:16px;height:16px;border:2px solid var(--border);border-top-color:var(--accent-2);border-radius:999px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#0f1420;border:1px solid var(--border);border-radius:6px;padding:2px 6px;font-size:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:8px 0 18px 0">IPTV Player <span class="hint">(.m3u8 / .m3u)</span></h1>

    <div class="card" id="loaderCard">
      <div class="card-h">
        <strong>Nh·∫≠p li√™n k·∫øt</strong>
        <span class="hint">D√°n URL .m3u8 /.m3u (ho·∫∑c ch·ªçn t·ªáp)</span>
        <span class="right"></span>
        <label class="pill" title="Ch·ªçn t·ªáp t·ª´ m√°y">
          <input id="fileInput" type="file" accept=".m3u8,.m3u,.txt,application/vnd.apple.mpegurl" style="display:none" />
          <span>üìÅ T·∫£i t·ªáp</span>
        </label>
      </div>
      <div class="card-b stack">
        <div class="row">
          <input id="urlInput" type="text" placeholder="https://.../playlist.m3u8 ho·∫∑c .../channels.m3u"/>
          <button id="loadBtn" class="primary">T·∫£i</button>
          <button id="demoBtn" title="Th·ª≠ URL m·∫´u" class="ghost">Demo</button>
        </div>
        <div class="hint">
          N·∫øu danh s√°ch ph√°t (.m3u/.m3u8) ch·ª©a nhi·ªÅu m·ª•c, ch√∫ng s·∫Ω hi·ªán ·ªü b·∫£ng b√™n ph·∫£i. Ch·ªçn m·ª•c ƒë·ªÉ ph√°t.
          <br/>N·∫øu g·∫∑p l·ªói CORS, xem ph·∫ßn <span class="kbd">CORS_PREFIX</span> trong m√£ ƒë·ªÉ b·∫≠t proxy ri√™ng.
        </div>
        <div class="recent" id="recentWrap"></div>
      </div>
    </div>

    <div class="grid" style="margin-top:18px">
      <div class="card">
        <div class="card-h">
          <strong>Tr√¨nh ph√°t</strong>
          <span class="right nowplaying"><span class="badge" id="qualBadge" style="display:none"></span><span id="nowTitle" class="hint">Ch∆∞a ph√°t</span></span>
        </div>
        <div class="card-b">
          <video id="video" controls playsinline></video>
          <div id="status" class="hint" style="margin-top:8px"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-h">
          <strong>Danh s√°ch</strong>
          <span class="right"><span id="listInfo" class="hint"></span></span>
        </div>
        <div class="card-b">
          <div id="list" class="list">
            <div class="empty">Ch∆∞a c√≥ danh s√°ch.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- hls.js for non-Safari browsers -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.17/dist/hls.min.js"></script>
  <script>
  (function(){
    const $ = (sel)=>document.querySelector(sel);
    const video = $('#video');
    const loadBtn = $('#loadBtn');
    const urlInput = $('#urlInput');
    const fileInput = $('#fileInput');
    const list = $('#list');
    const listInfo = $('#listInfo');
    const nowTitle = $('#nowTitle');
    const qualBadge = $('#qualBadge');
    const statusBox = $('#status');
    const demoBtn = $('#demoBtn');
    const recentWrap = $('#recentWrap');

    // ========================= CORS helper (optional) =========================
    // If your streams block cross-origin, set a proxy prefix you control, e.g.:
    // const CORS_PREFIX = 'https://your-proxy.example.com/';
    const CORS_PREFIX = '';
    // ========================================================================

    const RECENT_KEY = 'iptv_recent_urls_v1';
    const MAX_RECENT = 8;

    let hls = null; // hls.js instance
    let currentItems = []; // parsed playlist items

    function setStatus(msg, isError=false){
      statusBox.innerHTML = msg ? (isError? '<span class="danger">'+msg+'</span>' : msg) : '';
    }

    function saveRecent(url){
      try{
        const list = JSON.parse(localStorage.getItem(RECENT_KEY) || '[]');
        const next = [url, ...list.filter(u => u!==url)].slice(0, MAX_RECENT);
        localStorage.setItem(RECENT_KEY, JSON.stringify(next));
        renderRecent();
      }catch(e){}
    }
    function renderRecent(){
      const arr = JSON.parse(localStorage.getItem(RECENT_KEY) || '[]');
      recentWrap.innerHTML = '';
      arr.forEach(u=>{
        const b = document.createElement('button');
        b.className='pill'; b.textContent = new URLSafe(u).display;
        b.title = u; b.onclick = ()=>{ urlInput.value = u; loadFromURL(); };
        recentWrap.appendChild(b);
      });
      if(arr.length===0){
        const hint = document.createElement('div');
        hint.className='hint'; hint.textContent='Ch∆∞a c√≥ URL g·∫ßn ƒë√¢y.';
        recentWrap.appendChild(hint);
      }
    }

    class URLSafe{
      constructor(u){ this.u = u; }
      get display(){
        try{ const x = new URL(this.u); return (x.hostname + x.pathname).slice(0,60) + (x.search?'?‚Ä¶':''); }
        catch{ return this.u.slice(0,60); }
      }
    }

    function clearList(){ list.innerHTML = '<div class="empty">Ch∆∞a c√≥ danh s√°ch.</div>'; listInfo.textContent=''; currentItems=[]; }

    function renderList(items){
      currentItems = items || [];
      if(!currentItems.length){ clearList(); return; }
      list.innerHTML = '';
      currentItems.forEach((it,idx)=>{
        const row = document.createElement('div');
        row.className='item';
        row.onclick = ()=> playItem(it);
        const logo = document.createElement('img');
        logo.className='logo'; logo.loading='lazy'; logo.alt='';
        if(it.logo) logo.src = it.logo; else logo.style.opacity=.5;
        const col = document.createElement('div');
        const t = document.createElement('div'); t.className='title'; t.textContent = it.name || it.resolution || it.url || 'M·ª•c '+(idx+1);
        const m = document.createElement('div'); m.className='meta';
        const parts = [];
        if(it.group) parts.push(it.group);
        if(it.resolution) parts.push(it.resolution);
        if(it.bandwidth) parts.push(Math.round(it.bandwidth/1000)+' kbps');
        if(it.audio) parts.push('audio:'+it.audio);
        if(it.tvgId) parts.push('id:'+it.tvgId);
        m.textContent = parts.join(' ‚Ä¢ ');
        col.appendChild(t); col.appendChild(m);
        row.appendChild(logo); row.appendChild(col);
        list.appendChild(row);
      });
      listInfo.textContent = `${currentItems.length} m·ª•c`;
    }

    function detachHls(){
      if(hls){ try{ hls.destroy(); }catch(e){} hls=null; }
      video.src = '';
      qualBadge.style.display='none';
    }

    function useNativeHls(){
      const v = document.createElement('video');
      return v.canPlayType('application/vnd.apple.mpegURL');
    }

    async function playURL(url, title){
      detachHls();
      nowTitle.textContent = title || new URLSafe(url).display;
      setStatus('ƒêang t·∫£i‚Ä¶ <span class="spinner"></span>');
      try{
        if(useNativeHls()){
          video.src = url; await video.play().catch(()=>{});
          setStatus('');
        }else if(window.Hls && window.Hls.isSupported()){
          hls = new Hls({
            maxBufferLength: 30,
            maxMaxBufferLength: 120,
            backBufferLength: 90,
          });
          hls.on(Hls.Events.MANIFEST_PARSED, (_, data)=>{
            setStatus('');
            const levels = (data && data.levels) || [];
            if(levels.length){
              const best = levels.reduce((a,b)=> (b.height||0)>(a.height||0)?b:a, levels[0]);
              qualBadge.style.display='inline-block';
              qualBadge.textContent = (best.height? best.height+'p' : (best.bitrate? Math.round(best.bitrate/1000)+' kbps' : 'HLS'));
            }
          });
          hls.on(Hls.Events.ERROR, (_, data)=>{
            if(data && data.fatal){ setStatus('L·ªói HLS: '+ data.type + ' ‚Äì ' + (data.details||''), true); }
          });
          hls.loadSource(url);
          hls.attachMedia(video);
        }else{
          // Fallback: try to set src (may fail in some browsers)
          video.src = url; await video.play().catch(()=>{});
          setStatus('');
        }
      }catch(err){
        setStatus('Kh√¥ng ph√°t ƒë∆∞·ª£c: '+ err.message, true);
      }
    }

    function playItem(it){
      if(!it) return;
      playURL(it.url, it.name || it.resolution || it.url);
    }

    // ---------- Parsing ----------
    function parseM3U(content, base){
      // Returns array of items: {name,url,group,logo,tvgId}
      const lines = content.split(/\r?\n/);
      if(!lines.some(l=>l.trim().startsWith('#EXTM3U'))) return [];
      const items=[];
      let cur={};
      for(let i=0;i<lines.length;i++){
        const l = lines[i].trim();
        if(l.startsWith('#EXTINF')){
          cur = {};
          // Attributes inside #EXTINF:-1 attr1=".." attr2="..", Title
          const commaIdx = l.indexOf(',');
          const info = commaIdx>=0 ? l.slice(0, commaIdx) : l;
          const title = commaIdx>=0 ? l.slice(commaIdx+1).trim() : '';
          cur.name = title || '';
          const attrRegex = /(\w[\w-]*?)\s*=\s*"([^"]*)"/g;
          let m;
          while((m = attrRegex.exec(info))){
            const k=m[1]; const v=m[2];
            if(k==='group-title') cur.group=v;
            if(k==='tvg-logo' || k==='logo') cur.logo=v;
            if(k==='tvg-id') cur.tvgId=v;
          }
          // find next non-comment URL line
          let j=i+1;
          while(j<lines.length){
            const u = lines[j].trim();
            if(u && !u.startsWith('#')){ cur.url = absolutize(u, base); items.push(cur); i=j; break; }
            j++;
          }
        }
      }
      return items;
    }

    function parseHlsMaster(content, base){
      // Parses #EXT-X-STREAM-INF blocks into items: url,resolution,bandwidth,audio
      const lines = content.split(/\r?\n/);
      if(!lines.some(l=>l.includes('#EXTM3U'))) return [];
      const out=[];
      for(let i=0;i<lines.length;i++){
        const l = lines[i];
        if(l.startsWith('#EXT-X-STREAM-INF')){
          const attrs = parseAttrs(l.replace('#EXT-X-STREAM-INF:',''));
          const res = attrs['RESOLUTION'] || '';
          const bw = attrs['BANDWIDTH']? Number(attrs['BANDWIDTH']) : undefined;
          const audio = attrs['AUDIO'];
          // next line should be the variant URI
          let uri='';
          let j=i+1; while(j<lines.length){ const cand=lines[j].trim(); if(cand && !cand.startsWith('#')){ uri=cand; i=j; break;} j++; }
          if(uri){
            out.push({
              url: absolutize(uri, base),
              resolution: res ? res.split('x')[1] + 'p' : undefined,
              bandwidth: bw,
              audio: audio
            });
          }
        }
      }
      return out;
    }

    function parseAttrs(s){
      const obj={};
      // Key=Value, value may be quoted or not.
      const re = /(\w+)=("([^"]*)"|[^,]*)/g; let m;
      while((m=re.exec(s))){ obj[m[1]] = m[3] ?? m[2]; }
      return obj;
    }

    function absolutize(u, base){
      try{ return new URL(u, base).toString(); }catch{ return u; }
    }

    async function fetchText(url){
      const res = await fetch(CORS_PREFIX + url, {mode: CORS_PREFIX? 'cors' : 'no-cors'}).catch(e=>{ throw e; });
      // When using no-cors, we may get an opaque response we cannot read.
      // So we fallback to regular fetch without forced mode.
      try{
        if(res && res.ok && res.type !== 'opaque') return await res.text();
      }catch(e){}
      const res2 = await fetch(CORS_PREFIX + url).catch(e=>{ throw e; });
      if(!res2.ok) throw new Error('HTTP '+res2.status);
      return await res2.text();
    }

    async function loadFromURL(){
      const raw = (urlInput.value||'').trim();
      if(!raw) return;
      const url = raw;
      clearList(); setStatus('ƒêang t·∫£i danh s√°ch‚Ä¶ <span class="spinner"></span>');
      try{
        const text = await fetchText(url);
        setStatus('ƒêang ph√¢n t√≠ch‚Ä¶');
        const isM3U = /#EXTM3U/i.test(text);
        if(!isM3U){
          // Not a playlist? Try to play directly as a stream URL
          setStatus('Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c danh s√°ch. Th·ª≠ ph√°t tr·ª±c ti·∫øp.');
          renderList([]);
          playURL(url, new URLSafe(url).display);
          saveRecent(url);
          return;
        }

        // Try HLS Master first
        const masterItems = parseHlsMaster(text, url);
        if(masterItems.length){
          renderList(masterItems);
          setStatus('ƒê√£ ƒë·ªçc HLS master: ch·ªçn ch·∫•t l∆∞·ª£ng ƒë·ªÉ ph√°t.');
          saveRecent(url);
          return;
        }

        // Otherwise, assume M3U with EXTINF
        const items = parseM3U(text, url);
        if(items.length){
          renderList(items);
          setStatus('ƒê√£ ƒë·ªçc danh s√°ch k√™nh. Ch·ªçn m·ª•c ƒë·ªÉ ph√°t.');
          saveRecent(url);
          return;
        }

        // Could be an HLS media playlist (single variant). Just play the URL itself.
        setStatus('Danh s√°ch kh√¥ng c√≥ m·ª•c con. Th·ª≠ ph√°t tr·ª±c ti·∫øp.');
        renderList([]);
        playURL(url, new URLSafe(url).display);
        saveRecent(url);
      }catch(err){
        console.error(err);
        setStatus('Kh√¥ng t·∫£i ƒë∆∞·ª£c: '+ err.message + ' (c√≥ th·ªÉ do CORS)', true);
      }
    }

    async function loadFromFile(file){
      if(!file) return;
      const text = await file.text();
      clearList(); setStatus('ƒêang ph√¢n t√≠ch t·ªáp‚Ä¶');
      const base = 'file:///'+encodeURIComponent(file.name);
      // Try parsers
      const masterItems = parseHlsMaster(text, base);
      if(masterItems.length){ renderList(masterItems); setStatus('T·ªáp HLS master ‚Äì ch·ªçn ch·∫•t l∆∞·ª£ng.'); return; }
      const items = parseM3U(text, base);
      if(items.length){ renderList(items); setStatus('ƒê√£ ƒë·ªçc danh s√°ch k√™nh t·ª´ t·ªáp.'); return; }
      // Fallback: not a playlist, treat as direct URL content (unlikely for local file)
      setStatus('T·ªáp kh√¥ng ch·ª©a danh s√°ch h·ª£p l·ªá.', true);
    }

    // Events
    loadBtn.addEventListener('click', loadFromURL);
    urlInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') loadFromURL(); });
    fileInput.addEventListener('change', (e)=>{ const f=e.target.files[0]; loadFromFile(f); e.target.value=''; });
    document.querySelector('[title="Ch·ªçn t·ªáp t·ª´ m√°y"]').addEventListener('click', ()=> fileInput.click());
    demoBtn.addEventListener('click', ()=>{
      urlInput.value = 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8';
      loadFromURL();
    });

    renderRecent();
  })();
  </script>
</body>
</html>
