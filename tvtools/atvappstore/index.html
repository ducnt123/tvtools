<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ATV App Store</title>
  <!--
    Mini App Store – single‑file, no backend.
    ✦ Tính năng chính
      • Tìm kiếm theo tên, gói, mô tả, danh mục
      • Tải về bằng liên kết downloadUrl
      • Admin: thêm / sửa / xóa ứng dụng
      • Import / Export dữ liệu (.json)
      • Lưu cục bộ bằng localStorage (có sẵn dữ liệu mẫu)
    ✦ Ghi chú triển khai
      • Upload file này lên hosting (cPanel) là chạy được.
      • Để dùng nhiều máy & đồng bộ, xem phần TODO backend ở cuối.
    ✦ Bảo mật
      • Đây là bản demo front‑end, không có backend nên “Admin key” chỉ mang tính ẩn giao diện.
      • Hãy thay ADMIN_KEY phía dưới và/hoặc nối backend thật nếu dùng sản xuất.
  -->
  <style>
    :root{
      --bg:#0b0c0f; --panel:#12141a; --text:#e8ecf1; --muted:#9aa4b2; --accent:#4f8cff;
      --accent-2:#20d1a3; --danger:#ff5577; --border:#232836; --card:#171a21;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif}
    a{color:inherit}

    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,var(--panel),#0b0c0f80 70%,transparent);
      border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700}
    .brand .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#7aa8ff)}

    input, select, textarea, button{background:var(--card);border:1px solid var(--border);
      color:var(--text);border-radius:10px;padding:10px 12px;outline:0}
    input::placeholder, textarea::placeholder{color:var(--muted)}
    button{cursor:pointer}
    .btn{background:var(--accent);border:none;color:white;font-weight:600;box-shadow:0 6px 18px #4f8cff33}
    .btn.secondary{background:var(--accent-2)}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .btn.danger{background:var(--danger)}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .toolbar .grow{flex:1}

    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px;margin-top:16px}
    @media(min-width:700px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(min-width:1024px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}

    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;display:flex;gap:12px}
    .app-icon{width:64px;height:37px;border-radius:5px;background:#111;border:1px solid var(--border);flex:0 0 auto;object-fit:contain}
    .app-body{flex:1;min-width:0}
    .app-title{font-weight:700;display:flex;gap:8px;align-items:center}
    .badge{font-size:.8rem;padding:2px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted)}
    .desc{color:var(--muted);margin:6px 0 10px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .meta{font-size:.85rem;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    .panel{margin-top:24px;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
    .panel h3{margin:0 0 8px}
    .two{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:860px){.two{grid-template-columns:1fr 1fr}}

    .admin-hidden{display:none}

    footer{opacity:.75;margin:36px 0;text-align:center;color:var(--muted)}
    .hr{height:1px;background:var(--border);margin:12px 0}
    .chipbar{display:flex;gap:6px;flex-wrap:wrap}
    .chip{padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted);cursor:pointer}
    .chip.active{background:var(--accent);border-color:transparent;color:#fff}
    .empty{padding:24px;border:1px dashed var(--border);border-radius:16px;text-align:center;color:var(--muted)}

    .hint{font-size:.9rem;color:var(--muted)}
    label{display:block;font-size:.9rem;color:var(--muted);margin-bottom:6px}
    .field{display:flex;flex-direction:column;gap:6px}

    .right{margin-left:auto}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div class="brand"><div class="logo" aria-hidden></div> ATV App Store</div>
        <div class="right row" style="gap:8px">
          <input id="adminKeyInput" type="password" placeholder="Nhập mã" aria-label="Nhập mã" />
          <button class="btn" id="toggleAdminBtn" aria-pressed="false">Đăng nhập</button>
        </div>
      </div>
      <div class="toolbar">
        <input class="grow" id="searchInput" type="search" placeholder="Tìm theo tên, gói, mô tả… (gõ để lọc)" aria-label="Tìm kiếm" />
        <select id="categoryFilter" aria-label="Lọc theo danh mục">
          <option value="">Tất cả danh mục</option>
        </select>
        <select id="sortSelect" aria-label="Sắp xếp">
          <option value="recent">Cập nhật mới nhất</option>
          <option value="name">Tên (A→Z)</option>
          <option value="size">Dung lượng (nhỏ→lớn)</option>
        </select>
        <button class="btn ghost" id="resetBtn">Đặt lại</button>
      </div>
      <div class="chipbar" id="quickCats" style="margin-top:10px"></div>
    </div>
  </header>

  <main class="wrap">
    <section id="listSection">
      <div class="grid" id="appGrid" aria-live="polite"></div>
      <div class="empty" id="emptyState" hidden>Không có ứng dụng nào khớp bộ lọc hiện tại.</div>
    </section>

    <section class="panel admin-hidden" id="adminPanel" aria-label="Bảng quản trị">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3>Quản trị ứng dụng</h3>
        <div class="row" style="gap:8px">
          <button class="btn secondary" id="exportBtn">Export JSON</button>
          <label class="btn ghost" for="importFile" style="cursor:pointer">Import JSON</label>
          <input id="importFile" type="file" accept="application/json" hidden />
          <button class="btn ghost" id="seedBtn" title="Thêm dữ liệu mẫu">Seed mẫu</button>
          <button class="btn danger" id="wipeBtn" title="Xóa tất cả dữ liệu">Xóa tất cả</button>
        </div>
      </div>
      <div class="hr"></div>

      <div class="two">
        <!-- FORM NHẬP / SỬA ỨNG DỤNG -->
        <form id="appForm" aria-label="Form ứng dụng">
          <input type="hidden" id="appId" />
          <div class="field"><label for="name">Tên ứng dụng *</label><input id="name" required placeholder="VD: Karaoke TV" /></div>
          <div class="field"><label for="pkg">Mã gói (package)</label><input id="pkg" placeholder="VD: com.example.karaoke" /></div>
          <div class="field"><label for="version">Phiên bản</label><input id="version" placeholder="VD: 1.2.0" /></div>
          <div class="field"><label for="size">Dung lượng (MB)</label><input id="size" type="number" step="0.1" min="0" placeholder="VD: 23.5" /></div>
          <div class="field"><label for="category">Danh mục</label><input id="category" placeholder="VD: Giải trí" /></div>
          <div class="field"><label for="updated">Ngày cập nhật</label><input id="updated" type="date" /></div>
          <div class="field"><label for="iconUrl">Icon URL</label><input id="iconUrl" placeholder="https://…/icon.png" /></div>
          <div class="field"><label for="downloadUrl">Tệp tải về (APK/ZIP/Link) *</label><input id="downloadUrl" required placeholder="https://…/file.apk" /></div>
          <div class="field"><label for="desc">Mô tả</label><textarea id="desc" rows="4" placeholder="Mô tả ngắn gọn…"></textarea></div>
          <div class="row" style="gap:8px;margin-top:8px">
            <button class="btn" type="submit" id="saveBtn">Thêm ứng dụng</button>
            <button class="btn ghost" type="button" id="clearBtn">Làm mới form</button>
          </div>
          <div class="hint">Mẹo: dán URL icon và URL tải để xem trước ngay ở danh sách.</div>
        </form>

        <!-- DANH SÁCH QUẢN TRỊ -->
        <div>
          <h4 style="margin:0 0 8px">Danh sách (bấm Sửa/Xóa)</h4>
          <div id="adminList"></div>
        </div>
      </div>
    </section>

    <footer>© <span id="year"></span> ATV App Store • Kho ứng dụng dành cho Android TV</footer>
  </main>

  <script>
  // ======= CẤU HÌNH CƠ BẢN =======
  const STORAGE_KEY = 'appstore_data_v1';
  const ADMIN_KEY_STORAGE = 'appstore_admin_key';
  const DEFAULT_ADMIN_KEY = 'atv_appstore'

  // ======= TRẠNG THÁI / TIỆN ÍCH =======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const state = {
    apps: [],
    admin: false,
    filter: { q: '', cat: '', sort: 'recent' },
  };

  function uid(){ return Math.random().toString(36).slice(2,10) }
  function toMB(n){ return (n||0).toString() }
  function fmtDate(d){ if(!d) return ''; const x = new Date(d); return x.toLocaleDateString('vi-VN') }

  // ======= PERSISTENCE =======
  function loadData(){
    try{ const raw = localStorage.getItem(STORAGE_KEY); state.apps = raw ? JSON.parse(raw) : [] }catch{ state.apps=[] }
  }
  function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.apps)) }
  function getAdminKey(){ return localStorage.getItem(ADMIN_KEY_STORAGE) || DEFAULT_ADMIN_KEY }
  function setAdminKey(k){ localStorage.setItem(ADMIN_KEY_STORAGE, k) }

  // ======= RENDER DANH MỤC / LỌC =======
  function computeCategories(){
    const s = new Set(); state.apps.forEach(a=>{ if(a.category) s.add(a.category) });
    return [''].concat([...s].sort())
  }
  function renderCategoryFilter(){
    const sel = $('#categoryFilter'); sel.innerHTML = computeCategories().map(c=>`<option value="${c}">${c||'Tất cả danh mục'}</option>`).join('')
  }
  function renderQuickCats(){
    const box = $('#quickCats');
    const cats = computeCategories().slice(1).slice(0,8);
    box.innerHTML = cats.map(c=>`<button class="chip" data-cat="${c}">${c}</button>`).join('');
    box.querySelectorAll('.chip').forEach(chip=>{
      chip.addEventListener('click',()=>{ state.filter.cat = chip.dataset.cat; $('#categoryFilter').value = state.filter.cat; renderList() })
    })
  }

  // ======= LỌC / SẮP XẾP =======
  function filterAndSort(apps){
    const q = state.filter.q.trim().toLowerCase();
    const cat = state.filter.cat.trim().toLowerCase();
    const sort = state.filter.sort;

    let out = apps.filter(a=>{
      const hay = [a.name,a.pkg,a.desc,a.category].map(x=> (x||'').toLowerCase()).join('\n');
      const okQ = !q || hay.includes(q);
      const okC = !cat || (a.category||'').toLowerCase()===cat;
      return okQ && okC;
    });

    out.sort((A,B)=>{
      if(sort==='name') return (A.name||'').localeCompare(B.name||'');
      if(sort==='size') return (parseFloat(A.size||0) - parseFloat(B.size||0));
      // recent:
      return new Date(B.updated||0) - new Date(A.updated||0);
    });

    return out;
  }

  // ======= RENDER DANH SÁCH ỨNG DỤNG =======
  function renderList(){
    const grid = $('#appGrid');
    const filtered = filterAndSort(state.apps);
    grid.innerHTML = '';

    if(!filtered.length){ $('#emptyState').hidden = false; return }
    $('#emptyState').hidden = true;

    filtered.forEach(a=>{
      const el = document.createElement('div'); el.className='card';
      el.innerHTML = `
        <img class="app-icon" src="${a.iconUrl||''}" alt="${a.name||'Icon'}" onerror="this.src='data:image/svg+xml;utf8,${encodeURIComponent(placeholderSvg())}'"/>
        <div class="app-body">
          <div class="app-title">${escapeHtml(a.name||'(Chưa có tên)')} ${a.category?`<span class="badge">${escapeHtml(a.category)}</span>`:''}</div>
          <div class="meta">${a.pkg?escapeHtml(a.pkg):''} ${a.version?` • v${escapeHtml(a.version)}`:''} ${a.size?` • ${toMB(a.size)} MB`:''} ${a.updated?` • Cập nhật: ${fmtDate(a.updated)}`:''}</div>
          <div class="desc">${escapeHtml(a.desc||'')}</div>
          <div class="actions">
            ${a.downloadUrl?`<a class="btn" href="${a.downloadUrl}" target="_blank" rel="noopener">Tải về</a>`:''}
            ${state.admin?`<button class="btn ghost" data-edit="${a.id}">Sửa</button>`:''}
            ${state.admin?`<button class="btn danger" data-del="${a.id}">Xóa</button>`:''}
          </div>
        </div>`;
      grid.appendChild(el);
    });

    if(state.admin){
      // gắn handler Sửa/Xóa trong danh sách chính
      grid.querySelectorAll('[data-edit]').forEach(b=> b.addEventListener('click',()=> editApp(b.dataset.edit)));
      grid.querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click',()=> delApp(b.dataset.del)));
    }

    renderAdminList();
  }

  function placeholderSvg(){
    return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'>
      <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
        <stop offset='0%' stop-color='%23202836' /><stop offset='100%' stop-color='%2312161f' />
      </linearGradient></defs>
      <rect rx='22' width='120' height='120' fill='url(%23g)'/>
      <g fill='%234f8cff'><circle cx='60' cy='46' r='18'/><rect x='32' y='72' width='56' height='24' rx='10'/></g>
    </svg>`
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]))
  }

  // ======= ADMIN: FORM / CRUD =======
  function resetForm(){ $('#appId').value=''; $('#appForm').reset(); $('#saveBtn').textContent='Thêm ứng dụng' }

  function fromForm(){
    const obj = {
      id: $('#appId').value || uid(),
      name: $('#name').value.trim(),
      pkg: $('#pkg').value.trim(),
      version: $('#version').value.trim(),
      size: $('#size').value? Number($('#size').value) : '',
      category: $('#category').value.trim(),
      updated: $('#updated').value || new Date().toISOString().slice(0,10),
      iconUrl: $('#iconUrl').value.trim(),
      downloadUrl: $('#downloadUrl').value.trim(),
      desc: $('#desc').value.trim(),
    };
    return obj;
  }

  function toForm(a){
    $('#appId').value = a.id; $('#name').value = a.name||''; $('#pkg').value=a.pkg||'';
    $('#version').value=a.version||''; $('#size').value=a.size||''; $('#category').value=a.category||'';
    $('#updated').value=(a.updated||'').slice(0,10); $('#iconUrl').value=a.iconUrl||''; $('#downloadUrl').value=a.downloadUrl||''; $('#desc').value=a.desc||'';
    $('#saveBtn').textContent='Lưu thay đổi';
    window.scrollTo({top: document.body.scrollHeight, behavior:'smooth'});
  }

  function upsertApp(obj){
    const i = state.apps.findIndex(x=>x.id===obj.id);
    if(i>=0) state.apps[i]=obj; else state.apps.unshift(obj); // thêm lên đầu
    saveData(); renderCategoryFilter(); renderQuickCats(); renderList(); resetForm();
  }

  function editApp(id){ const a = state.apps.find(x=>x.id===id); if(a) toForm(a) }
  function delApp(id){ if(!confirm('Xóa ứng dụng này?')) return; state.apps = state.apps.filter(x=>x.id!==id); saveData(); renderCategoryFilter(); renderQuickCats(); renderList(); }

  function renderAdminList(){
    if(!state.admin) return;
    const box = $('#adminList');
    box.innerHTML = state.apps.map(a=>`
      <div class="card" style="align-items:center">
        <img class="app-icon" src="${a.iconUrl||''}" alt="" onerror="this.src='data:image/svg+xml;utf8,${encodeURIComponent(placeholderSvg())}'"/>
        <div class="app-body">
          <div class="app-title">${escapeHtml(a.name||'(No name)')}</div>
          <div class="meta">${a.pkg||''} • ${a.category||''}</div>
        </div>
        <div class="row" style="gap:6px">
          <button class="btn ghost" onclick="editApp('${a.id}')">Sửa</button>
          <button class="btn danger" onclick="delApp('${a.id}')">Xóa</button>
        </div>
      </div>`).join('');
  }

  // ======= IMPORT / EXPORT =======
  function exportJson(){
    const blob = new Blob([JSON.stringify(state.apps,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'apps.json'; a.click(); URL.revokeObjectURL(a.href);
  }
  function importJson(file){
    const reader = new FileReader();
    reader.onload = e => { try{ const data = JSON.parse(e.target.result); if(Array.isArray(data)){ state.apps = data; saveData(); renderCategoryFilter(); renderQuickCats(); renderList(); alert('Import thành công!') } else alert('Tệp không đúng định dạng (mảng)') } catch(err){ alert('Không đọc được JSON: '+err.message) } };
    reader.readAsText(file);
  }

  function seedSample(){
    const today = new Date().toISOString().slice(0,10);
    state.apps = [
      [
  {
    "id": "spnqrdoq",
    "name": "VTVgo",
    "pkg": "vn.vtv.vtvgotv",
    "version": "",
    "size": 46,
    "category": "Giải trí",
    "updated": "2025-11-07",
    "iconUrl": "https://cdn.save.moe/b/4eEZD5.png?dl=1",
    "downloadUrl": "https://www.dropbox.com/scl/fi/lcplqk4zo7lon7wsghrdp/vn.vtv.vtvgotv.apk?rlkey=kjnxof89kwvxp64yn4e8hag55&st=9l53jya9&dl=1",
    "desc": ""
  },
  {
    "id": "f8sr125d",
    "name": "YouTube",
    "pkg": "com.example.youtubetvwebview",
    "version": "1.0",
    "size": 6.6,
    "category": "Giải trí",
    "updated": "2025-11-07",
    "iconUrl": "https://cdn.save.moe/b/d05zf2.png?dl=1",
    "downloadUrl": "https://www.dropbox.com/scl/fi/9yw7lk0rtwoga4780b160/youtube_for_androidtv_webview.apk?rlkey=qybtk1t273m282gn1i4o021iq&st=4g3se5mr&dl=1",
    "desc": "YouTube for Android TV"
  }
]
    ];
    saveData(); renderCategoryFilter(); renderQuickCats(); renderList();
  }

  // ======= SỰ KIỆN UI =======
  function bindEvents(){
    $('#searchInput').addEventListener('input', e=>{ state.filter.q = e.target.value; renderList() });
    $('#categoryFilter').addEventListener('change', e=>{ state.filter.cat = e.target.value; renderList() });
    $('#sortSelect').addEventListener('change', e=>{ state.filter.sort = e.target.value; renderList() });
    $('#resetBtn').addEventListener('click', ()=>{ state.filter={q:'',cat:'',sort:'recent'}; $('#searchInput').value=''; $('#categoryFilter').value=''; $('#sortSelect').value='recent'; renderList() });

    $('#appForm').addEventListener('submit', e=>{ e.preventDefault(); const obj = fromForm(); if(!obj.name || !obj.downloadUrl){ alert('Tên & Tệp tải về là bắt buộc'); return } upsertApp(obj) });
    $('#clearBtn').addEventListener('click', resetForm);

    $('#exportBtn').addEventListener('click', exportJson);
    $('#importFile').addEventListener('change', e=>{ if(e.target.files[0]) importJson(e.target.files[0]) });
    $('#seedBtn').addEventListener('click', seedSample);
    $('#wipeBtn').addEventListener('click', ()=>{ if(confirm('Xóa toàn bộ dữ liệu?')){ state.apps=[]; saveData(); renderCategoryFilter(); renderQuickCats(); renderList(); resetForm() } });

    $('#toggleAdminBtn').addEventListener('click', ()=>{
      const keyInput = $('#adminKeyInput');
      const tryKey = keyInput.value.trim();
      const realKey = getAdminKey();
      if(!state.admin){
        if(tryKey && tryKey===realKey){ state.admin=true; $('#adminPanel').classList.remove('admin-hidden'); $('#toggleAdminBtn').textContent='Đóng quản trị'; $('#toggleAdminBtn').setAttribute('aria-pressed','true'); renderList() }
        else if(!tryKey){ alert('Nhập mã'); }
        else{ alert('Sai Admin key'); }
      } else {
        state.admin=false; $('#adminPanel').classList.add('admin-hidden'); $('#toggleAdminBtn').textContent='Mở quản trị'; $('#toggleAdminBtn').setAttribute('aria-pressed','false'); renderList()
      }
    });

    // Cho phép đổi admin key nếu đã mở quản trị
    $('#adminKeyInput').addEventListener('change', ()=>{
      if(state.admin){ setAdminKey($('#adminKeyInput').value.trim()); alert('Đã cập nhật Admin key (lưu trong trình duyệt)') }
    });
  }

  // ======= KHỞI TẠO =======
  function init(){
    $('#year').textContent = new Date().getFullYear();
    loadData();
    if(!state.apps.length) seedSample(); // có dữ liệu mẫu lần đầu
    renderCategoryFilter(); renderQuickCats(); bindEvents(); renderList();
  }

  document.addEventListener('DOMContentLoaded', init);
  </script>

  <!--
    ======= TODO BACKEND (khi cần mở rộng) =======
    1) Firebase/Firestore + Firebase Hosting:
       • Lưu danh sách apps theo bộ sưu tập, phân quyền bằng Auth.
       • Replace localStorage calls bằng fetch/subscribe Firestore.
    2) Supabase (Postgres + Row Level Security):
       • Bảng apps(id, name, pkg, version, size, category, updated, iconUrl, downloadUrl, desc)
       • REST auto (PostgREST) hoặc dùng JS client.
    3) GitHub Pages + JSON tĩnh:
       • Lưu apps.json trong repo, admin sửa file và deploy.
  -->
</body>
</html>
